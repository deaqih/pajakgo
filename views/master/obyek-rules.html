<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Obyek Rules - Accounting Web</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="/static/shared/pagination.js"></script>
</head>
<body class="bg-gray-100">
    <!-- Navbar -->
    <nav class="bg-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center space-x-4">
                    <a href="/" class="text-2xl font-bold text-blue-600">Accounting Web</a>
                    <span class="text-gray-400">|</span>
                    <span class="text-gray-600">Obyek Rules</span>
                </div>
                <div class="flex items-center space-x-4">
                    <span id="userDisplay" class="text-gray-700"></span>
                    <button onclick="logout()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded">
                        Logout
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div id="main-content" class="max-w-7xl mx-auto px-4 py-8">
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">Obyek Rules Management</h2>
                <div class="flex space-x-2">
                    <button onclick="downloadTemplate()" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded">
                        <i class="fas fa-file-download mr-2"></i>Template
                    </button>
                    <button onclick="exportRules()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded">
                        <i class="fas fa-download mr-2"></i>Export
                    </button>
                    <button onclick="showImportModal()" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded">
                        <i class="fas fa-upload mr-2"></i>Import
                    </button>
                    <button onclick="showAddModal()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded">
                        <i class="fas fa-plus mr-2"></i>Add Rule
                    </button>
                </div>
            </div>

            <!-- Search and Controls -->
            <div class="mb-4 flex justify-between items-center">
                <div class="search-box flex-1 max-w-md"></div>
                <div class="limit-selector"></div>
            </div>

            <!-- Table -->
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Keyword</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Value</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody" class="bg-white divide-y divide-gray-200">
                        <tr>
                            <td colspan="4" class="px-6 py-4 text-center text-gray-500">
                                <i class="fas fa-spinner fa-spin mr-2"></i>Loading...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <div class="mt-4 pagination-container"></div>
        </div>
    </div>

    <!-- Add/Edit Modal -->
    <div id="ruleModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white">
            <div class="flex justify-between items-center mb-4">
                <h3 id="modalTitle" class="text-xl font-bold">Add Obyek Rule</h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            <form id="ruleForm" class="space-y-4">
                <input type="hidden" id="ruleId">
                <div class="grid grid-cols-1 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Keyword *</label>
                        <input type="text" id="keyword" required
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                            placeholder="e.g., PPH 21, PPH 23">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Value *</label>
                        <input type="text" id="value" required
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                            placeholder="e.g., 21, 23">
                    </div>
                    <div>
                        <label class="flex items-center">
                            <input type="checkbox" id="isActive" checked class="mr-2">
                            <span class="text-sm font-medium text-gray-700">Is Active</span>
                        </label>
                    </div>
                </div>
                <div id="errorMessage" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded"></div>
                <div class="flex space-x-2">
                    <button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 rounded-lg">
                        Save
                    </button>
                    <button type="button" onclick="closeModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 rounded-lg">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Import Modal -->
    <div id="importModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">Import Obyek Rules</h3>
                <button onclick="closeImportModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            <form id="importForm">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Upload Excel File</label>
                    <input type="file" id="importFile" accept=".xlsx,.xls" required
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                    <p class="text-xs text-gray-500 mt-2">
                        Format: Keyword, Value, Is Active
                    </p>
                    <div class="mt-2">
                        <button type="button" onclick="downloadTemplate()" class="text-blue-600 hover:text-blue-800 text-sm">
                            <i class="fas fa-download mr-1"></i>Download Template Excel
                        </button>
                    </div>
                </div>
                <div id="importError" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4"></div>
                <div id="importSuccess" class="hidden bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-4"></div>
                <div class="flex space-x-2">
                    <button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 rounded-lg">
                        Import
                    </button>
                    <button type="button" onclick="closeImportModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 rounded-lg">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const token = localStorage.getItem('access_token');
        if (!token) window.location.href = '/login';

        const user = JSON.parse(localStorage.getItem('user') || '{}');
        document.getElementById('userDisplay').textContent = user.username || 'User';

        let allRules = [];

        function logout() {
            localStorage.removeItem('access_token');
            localStorage.removeItem('user');
            window.location.href = '/login';
        }

        async function loadRules(page = 1, limit = 25, search = '') {
            // Show loading state
            document.getElementById('tableBody').innerHTML =
                `<tr><td colspan="4" class="px-6 py-4 text-center text-gray-500">
                    <i class="fas fa-spinner fa-spin mr-2"></i>Loading...
                </td></tr>`;

            try {
                const params = new URLSearchParams({
                    page: page,
                    limit: limit,
                    search: search
                });

                const response = await fetch(`/api/v1/obyek-rules?${params}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const data = await response.json();

                if (data.success) {
                    allRules = data.data.rules || [];
                    displayRules(allRules);

                    // Update pagination if available
                    if (data.data.pagination) {
                        paginationManager.updateData(data.data.pagination);
                        paginationManager.render();
                    }
                } else {
                    document.getElementById('tableBody').innerHTML =
                        `<tr><td colspan="4" class="px-6 py-4 text-center text-gray-500">Failed to load rules</td></tr>`;
                }
            } catch (error) {
                document.getElementById('tableBody').innerHTML =
                    `<tr><td colspan="4" class="px-6 py-4 text-center text-red-500">Error: ${error.message}</td></tr>`;
            }
        }

        function displayRules(rules) {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            if (rules.length === 0) {
                tbody.innerHTML = `<tr><td colspan="4" class="px-6 py-4 text-center text-gray-500">No rules found</td></tr>`;
                return;
            }

            rules.forEach(rule => {
                const statusBadge = rule.is_active
                    ? '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">Active</span>'
                    : '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-800">Inactive</span>';

                const row = `
                    <tr>
                        <td class="px-6 py-4">${safeValue(rule.keyword)}</td>
                        <td class="px-6 py-4">${safeValue(rule.value)}</td>
                        <td class="px-6 py-4">${statusBadge}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <button onclick="editRule(${rule.id})" class="text-blue-600 hover:text-blue-900 mr-3">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteRule(${rule.id})" class="text-red-600 hover:text-red-900">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        function safeValue(value, defaultValue = '') {
            if (value === null || value === undefined || value === 'null' || value === 'undefined') {
                return defaultValue;
            }
            return String(value).trim() || defaultValue;
        }

        function showAddModal() {
            document.getElementById('modalTitle').textContent = 'Add Obyek Rule';
            document.getElementById('ruleForm').reset();
            document.getElementById('ruleId').value = '';
            document.getElementById('isActive').checked = true;
            document.getElementById('errorMessage').classList.add('hidden');
            document.getElementById('ruleModal').classList.remove('hidden');
        }

        async function editRule(id) {
            try {
                const response = await fetch(`/api/v1/obyek-rules/${id}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const data = await response.json();

                if (data.success) {
                    document.getElementById('modalTitle').textContent = 'Edit Obyek Rule';
                    document.getElementById('ruleId').value = data.data.id;
                    document.getElementById('keyword').value = data.data.keyword || '';
                    document.getElementById('value').value = data.data.value || '';
                    document.getElementById('isActive').checked = data.data.is_active;
                    document.getElementById('errorMessage').classList.add('hidden');
                    document.getElementById('ruleModal').classList.remove('hidden');
                }
            } catch (error) {
                alert('Failed to load rule: ' + error.message);
            }
        }

        async function deleteRule(id) {
            if (!confirm('Are you sure you want to delete this rule?')) return;

            try {
                const response = await fetch(`/api/v1/obyek-rules/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const data = await response.json();

                if (data.success) {
                    loadRules(paginationManager.currentPage, paginationManager.itemsPerPage, paginationManager.currentSearch);
                } else {
                    alert('Failed to delete rule: ' + data.message);
                }
            } catch (error) {
                alert('Failed to delete rule: ' + error.message);
            }
        }

        function closeModal() {
            document.getElementById('ruleModal').classList.add('hidden');
        }

        document.getElementById('ruleForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const id = document.getElementById('ruleId').value;
            const keyword = document.getElementById('keyword').value;
            const value = document.getElementById('value').value;
            const is_active = document.getElementById('isActive').checked;

            const payload = { keyword, value, is_active };

            try {
                const url = id ? `/api/v1/obyek-rules/${id}` : '/api/v1/obyek-rules';
                const method = id ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();

                if (data.success) {
                    closeModal();
                    loadRules(paginationManager.currentPage, paginationManager.itemsPerPage, paginationManager.currentSearch);
                } else {
                    document.getElementById('errorMessage').textContent = data.message;
                    document.getElementById('errorMessage').classList.remove('hidden');
                }
            } catch (error) {
                document.getElementById('errorMessage').textContent = error.message;
                document.getElementById('errorMessage').classList.remove('hidden');
            }
        });

        async function exportRules() {
            try {
                const response = await fetch('/api/v1/obyek-rules/export', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `koreksi_rules_export_${new Date().toISOString().split('T')[0]}.xlsx`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    a.remove();
                } else {
                    alert('Failed to export rules');
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        async function downloadTemplate() {
            try {
                const response = await fetch('/api/v1/obyek-rules/template', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'koreksi_rules_import_template.xlsx';
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    a.remove();
                } else {
                    alert('Failed to download template');
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        function showImportModal() {
            document.getElementById('importForm').reset();
            document.getElementById('importError').classList.add('hidden');
            document.getElementById('importSuccess').classList.add('hidden');
            document.getElementById('importModal').classList.remove('hidden');
        }

        function closeImportModal() {
            document.getElementById('importModal').classList.add('hidden');
        }

        document.getElementById('importForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const fileInput = document.getElementById('importFile');
            const file = fileInput.files[0];

            if (!file) {
                document.getElementById('importError').textContent = 'Please select a file';
                document.getElementById('importError').classList.remove('hidden');
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch('/api/v1/obyek-rules/import', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` },
                    body: formData
                });

                const data = await response.json();

                if (data.success || response.status === 206) {
                    document.getElementById('importError').classList.add('hidden');
                    document.getElementById('importSuccess').textContent = data.message || 'Import successful!';
                    document.getElementById('importSuccess').classList.remove('hidden');

                    setTimeout(() => {
                        closeImportModal();
                        loadRules(1, paginationManager.itemsPerPage, '');
                    }, 2000);
                } else {
                    document.getElementById('importSuccess').classList.add('hidden');
                    let errorMsg = data.message || 'Import failed';
                    if (data.errors && data.errors.length > 0) {
                        errorMsg += '\n\nFirst few errors:\n';
                        data.errors.slice(0, 5).forEach(err => {
                            errorMsg += `Row ${err.row}: ${err.message}\n`;
                        });
                    }
                    if (data.error_report_path) {
                        errorMsg += '\n\nDownload full error report for details.';
                    }
                    document.getElementById('importError').textContent = errorMsg;
                    document.getElementById('importError').classList.remove('hidden');
                }
            } catch (error) {
                document.getElementById('importSuccess').classList.add('hidden');
                document.getElementById('importError').textContent = 'Error: ' + error.message;
                document.getElementById('importError').classList.remove('hidden');
            }
        });

        // Initialize pagination with custom load function
        const paginationManager = new PaginationManager({
            loadDataFunction: loadRules,
            searchBoxSelector: '.search-box',
            limitSelectorSelector: '.limit-selector',
            paginationContainerSelector: '.pagination-container'
        });

        // Initial load
        loadRules();
    </script>
</body>
</html>
